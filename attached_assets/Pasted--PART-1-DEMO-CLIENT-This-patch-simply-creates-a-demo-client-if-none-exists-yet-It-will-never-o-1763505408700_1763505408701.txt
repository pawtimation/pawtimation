
⭐ PART 1 — DEMO CLIENT

This patch simply creates a demo client if none exists yet.
It will never overwrite real users.

✅ Add this to the bottom of repo.js, before the final export const repo = { ... }:

// --- DEMO CLIENT SEEDER (runs once) ----------------------------------------

async function seedDemoClient() {
  const businesses = Object.values(db.businesses);
  if (businesses.length === 0) return;

  const biz = businesses[0];

  // If the demo already exists, skip seed.
  const existing = Object.values(db.clients).find(
    c => c.email === "demo@client.com"
  );
  if (existing) return;

  const clientId = `client_demo_${Date.now()}`;
  db.clients[clientId] = {
    id: clientId,
    businessId: biz.id,
    name: "Demo Client",
    email: "demo@client.com"
  };

  // Also seed a login account
  const userId = `clientUser_demo_${Date.now()}`;
  db.clientUsers[userId] = {
    id: userId,
    clientId,
    businessId: biz.id,
    email: "demo@client.com",
    password: "test123"
  };

  console.log("✓ Demo client created: demo@client.com / test123");
}

// Run seeder on startup
seedDemoClient();

✅ How to use the demo client

Once the server restarts, you can log in immediately at:

/client/login

Credentials:
	•	Email: demo@client.com
	•	Password: test123

This instantly lets you test:

✔ Client dashboard
✔ Booking requests
✔ Status updates

⸻

⭐ PART 2 — PATCH 3

INVOICING + PAYMENTS + WHATSAPP LINK

This patch includes:
	1.	Invoice data model
	2.	Auto-create invoice when job is completed
	3.	Client can see invoices
	4.	Admin can send invoice via WhatsApp (with one click)
	5.	Stripe payment links (stubbed for now)
	6.	Paid / unpaid status
	7.	Revenue metrics (simple tally)

Again — all additions. No refactor. No breaking changes.

⸻

⭐ STEP 1 — Add Invoice Model to repo.js

Paste this near the top, where other db sections are:

db.invoices = db.invoices || {};

Now add these below the other repo functions (but above export):

// --- INVOICING -------------------------------------------------------------

async function createInvoice({ businessId, clientId, jobId, amount }) {
  const id = `inv_${Date.now()}_${Math.random().toString(36).slice(2)}`;
  const invoice = {
    id,
    businessId,
    clientId,
    jobId,
    amount,
    createdAt: new Date().toISOString(),
    status: "UNPAID",
    paymentUrl: `https://pay.stripe.com/link/${id}` // stubbed
  };
  db.invoices[id] = invoice;
  return invoice;
}

async function listInvoicesByBusiness(businessId) {
  return Object.values(db.invoices).filter(i => i.businessId === businessId);
}

async function listInvoicesByClient(clientId) {
  return Object.values(db.invoices).filter(i => i.clientId === clientId);
}

async function markInvoicePaid(id) {
  if (!db.invoices[id]) throw new Error("Invoice not found");
  db.invoices[id].status = "PAID";
  return db.invoices[id];
}


⸻

⭐ STEP 2 — Auto-generate invoice when job is marked completed

Find updateJob in repo.js.

Replace with this upgraded version:

async function updateJob(jobId, patch) {
  if (!db.jobs[jobId]) throw new Error("Job not found");

  const job = db.jobs[jobId];
  const beforeStatus = job.status;

  Object.assign(job, patch);

  // Auto-generate invoice when job moves to COMPLETED
  if (beforeStatus !== "COMPLETED" && patch.status === "COMPLETED") {
    const svc = db.services[job.serviceId];
    const amount = svc?.price || 0;

    await createInvoice({
      businessId: job.businessId,
      clientId: job.clientId,
      jobId: job.id,
      amount
    });
  }

  return db.jobs[jobId];
}

Now invoices appear the moment a job is completed.

⸻

⭐ STEP 3 — Admin Invoice Screen

Create:
src/screens/AdminInvoices.jsx

import React, { useEffect, useState } from "react";
import { repo } from "../../repo.js";

export function AdminInvoices({ business }) {
  const [invoices, setInvoices] = useState([]);
  const [clients, setClients] = useState([]);

  useEffect(() => {
    (async () => {
      if (!business) return;
      const [inv, c] = await Promise.all([
        repo.listInvoicesByBusiness(business.id),
        repo.listClientsByBusiness(business.id)
      ]);
      setInvoices(inv);
      setClients(c);
    })();
  }, [business]);

  const clientById = Object.fromEntries(
    clients.map(c => [c.id, c])
  );

  function whatsappLink(invoice) {
    const client = clientById[invoice.clientId];
    const text = encodeURIComponent(
      `Hi ${client?.name || ""}, your invoice is ready.\nAmount: £${invoice.amount}\nPay here: ${invoice.paymentUrl}`
    );
    return `https://wa.me/?text=${text}`;
  }

  return (
    <div className="space-y-4">
      <h1 className="text-xl font-semibold">Invoices</h1>

      <div className="card">
        {invoices.length === 0 ? (
          <p className="text-sm text-slate-600">No invoices yet.</p>
        ) : (
          <ul className="divide-y">
            {invoices
              .slice()
              .sort((a, b) => (b.createdAt || "").localeCompare(a.createdAt || ""))
              .map(inv => {
                const client = clientById[inv.clientId];
                return (
                  <li key={inv.id} className="py-3 text-sm">
                    <div className="font-medium">
                      £{inv.amount} — {client?.name || "Client"}
                    </div>
                    <div className="text-xs text-slate-500">
                      {new Date(inv.createdAt).toLocaleString()} — {inv.status}
                    </div>

                    <div className="flex gap-2 mt-2">
                      <a
                        href={inv.paymentUrl}
                        target="_blank"
                        rel="noreferrer"
                        className="btn btn-xs btn-primary"
                      >
                        View payment link
                      </a>

                      <a
                        href={whatsappLink(inv)}
                        target="_blank"
                        rel="noreferrer"
                        className="btn btn-xs btn-ghost"
                      >
                        Send via WhatsApp
                      </a>
                    </div>
                  </li>
                );
              })}
          </ul>
        )}
      </div>
    </div>
  );
}


⸻

⭐ STEP 4 — Add route to App.jsx

Add import at top:

import { AdminInvoices } from './AdminInvoices';

Add inside <Routes> with admin routes:

<Route path="/admin/invoices" element={<AdminGuard><AdminInvoices business={business} /></AdminGuard>} />


⸻

⭐ STEP 5 — Client invoice view

Create:
src/screens/ClientInvoices.jsx

import React, { useEffect, useState } from "react";
import { repo } from "../../repo.js";
import { Link } from "react-router-dom";

export function ClientInvoices() {
  const [invoices, setInvoices] = useState([]);
  const [client, setClient] = useState(null);

  useEffect(() => {
    const raw = localStorage.getItem("pt_client");
    if (!raw) return;
    const { clientId } = JSON.parse(raw);

    (async () => {
      const inv = await repo.listInvoicesByClient(clientId);
      setInvoices(inv);
      setClient(await repo.getClient(clientId));
    })();
  }, []);

  if (!client)
    return <div className="text-sm text-slate-600">Loading...</div>;

  return (
    <div className="space-y-4">
      <h1 className="text-xl font-semibold">Your invoices</h1>

      <div className="card">
        {invoices.length === 0 ? (
          <p className="text-sm text-slate-600">No invoices yet.</p>
        ) : (
          <ul className="divide-y">
            {invoices.map(inv => (
              <li key={inv.id} className="py-3 text-sm">
                <div className="font-medium">£{inv.amount}</div>
                <div className="text-xs text-slate-500">
                  {new Date(inv.createdAt).toLocaleString()} — {inv.status}
                </div>
                <a
                  href={inv.paymentUrl}
                  target="_blank"
                  rel="noreferrer"
                  className="btn btn-xs btn-primary mt-2"
                >
                  Pay now
                </a>
              </li>
            ))}
          </ul>
        )}
      </div>

      <Link className="btn btn-ghost btn-sm" to="/client/dashboard">
        Back
      </Link>
    </div>
  );
}

Add to App.jsx routes:

<Route path="/client/invoices" element={<ClientInvoices />} />


