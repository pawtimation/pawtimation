PART 1 â€” Staff Data Model Update

Add these fields to staff profiles:
	â€¢	services â†’ array of serviceIds they are trained/allowed to perform
	â€¢	availability â†’ weekly recurring availability (e.g., Monday 9â€“5)
	â€¢	exceptions â†’ any specific blocked dates (holidays, sick days)
	â€¢	maxConcurrentBookings â†’ for future advanced logic, default 1

If your staff records live in repo.js under users:

Add these defaults when creating staff (do it in repo if youâ€™re using templates).

â¸»

ğŸŸ¦ PART 2 â€” Repo Methods for Staff Scheduling

Open repo.js and add:

// STAFF â€” Availability
repo.saveStaffAvailability = async function (staffId, availability) {
  const staff = await repo.getUser(staffId);
  staff.availability = availability;
  return repo._save('users', staff);
};

repo.saveStaffServices = async function (staffId, services) {
  const staff = await repo.getUser(staffId);
  staff.services = services;
  return repo._save('users', staff);
};

repo.listStaffByBusiness = async function (businessId) {
  const all = await repo._list('users');
  return all.filter(u => u.businessId === businessId && u.role === 'staff');
};


â¸»

ğŸŸ¦ PART 3 â€” STAFF AVAILABILITY UI (Admin)

Create:

src/screens/AdminStaffAvailability.jsx

Paste:

import React, { useEffect, useState } from 'react';
import { repo } from '../../repo.js';

const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

export function AdminStaffAvailability() {
  const [staff, setStaff] = useState([]);
  const [selected, setSelected] = useState(null);
  const [availability, setAvailability] = useState({});

  useEffect(() => {
    load();
  }, []);

  async function load() {
    const raw = localStorage.getItem('pt_user');
    const user = JSON.parse(raw);
    const list = await repo.listStaffByBusiness(user.businessId);
    setStaff(list);
  }

  function openStaff(member) {
    setSelected(member);
    setAvailability(member.availability || {});
  }

  function updateDay(day, field, value) {
    setAvailability(prev => ({
      ...prev,
      [day]: { ...(prev[day] || {}), [field]: value }
    }));
  }

  async function save() {
    await repo.saveStaffAvailability(selected.id, availability);
    alert('Availability updated.');
  }

  if (!selected) {
    return (
      <div className="space-y-4">
        <h1 className="text-xl font-semibold">Staff Availability</h1>
        <p className="text-slate-600 text-sm">Select a staff member to edit availability.</p>

        <div className="grid md:grid-cols-2 gap-4">
          {staff.map(s => (
            <div
              key={s.id}
              className="card cursor-pointer hover:bg-slate-50"
              onClick={() => openStaff(s)}
            >
              <div className="font-semibold">{s.name}</div>
              <div className="text-xs text-slate-500">{s.email}</div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <button
        className="text-xs text-slate-500 hover:underline"
        onClick={() => setSelected(null)}
      >
        â† Back to staff
      </button>

      <h1 className="text-xl font-semibold">
        Availability Â· {selected.name}
      </h1>

      <div className="grid md:grid-cols-2 gap-4">
        {DAYS.map(day => (
          <div key={day} className="card space-y-2">
            <div className="font-medium">{day}</div>
            <input
              type="time"
              className="border rounded px-2 py-1 text-sm w-full"
              value={availability[day]?.start || ''}
              onChange={e => updateDay(day, 'start', e.target.value)}
            />
            <input
              type="time"
              className="border rounded px-2 py-1 text-sm w-full"
              value={availability[day]?.end || ''}
              onChange={e => updateDay(day, 'end', e.target.value)}
            />
          </div>
        ))}
      </div>

      <button className="btn btn-primary text-sm" onClick={save}>
        Save availability
      </button>
    </div>
  );
}


â¸»

ğŸŸ¦ PART 4 â€” STAFF SERVICES UI (Admin)

Businesses choose which services a worker can perform.

Create:

src/screens/AdminStaffServices.jsx

Paste:

import React, { useEffect, useState } from 'react';
import { repo } from '../../repo.js';

export function AdminStaffServices() {
  const [staff, setStaff] = useState([]);
  const [services, setServices] = useState([]);
  const [selected, setSelected] = useState(null);
  const [allowed, setAllowed] = useState([]);

  useEffect(() => {
    (async () => {
      const raw = localStorage.getItem('pt_user');
      const user = JSON.parse(raw);

      const [s, svc] = await Promise.all([
        repo.listStaffByBusiness(user.businessId),
        repo.listServicesByBusiness(user.businessId)
      ]);

      setStaff(s);
      setServices(svc);
    })();
  }, []);

  function open(member) {
    setSelected(member);
    setAllowed(member.services || []);
  }

  function toggle(serviceId) {
    if (allowed.includes(serviceId)) {
      setAllowed(allowed.filter(x => x !== serviceId));
    } else {
      setAllowed([...allowed, serviceId]);
    }
  }

  async function save() {
    await repo.saveStaffServices(selected.id, allowed);
    alert('Updated staff service permissions.');
  }

  if (!selected) {
    return (
      <div className="space-y-4">
        <h1 className="text-xl font-semibold">Staff Services</h1>
        <p className="text-slate-600 text-sm">Select a staff member.</p>

        <div className="grid md:grid-cols-2 gap-4">
          {staff.map(s => (
            <div
              key={s.id}
              className="card cursor-pointer hover:bg-slate-50"
              onClick={() => open(s)}
            >
              <div className="font-semibold">{s.name}</div>
              <div className="text-xs text-slate-500">{s.email}</div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <button
        className="text-xs text-slate-500 hover:underline"
        onClick={() => setSelected(null)}
      >
        â† Back to staff
      </button>

      <h1 className="text-xl font-semibold">
        Services Â· {selected.name}
      </h1>

      <div className="grid gap-3">
        {services.map(s => (
          <label key={s.id} className="flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              checked={allowed.includes(s.id)}
              onChange={() => toggle(s.id)}
            />
            {s.name}
          </label>
        ))}
      </div>

      <button className="btn btn-primary text-sm" onClick={save}>
        Save services
      </button>
    </div>
  );
}


â¸»

ğŸŸ¦ PART 5 â€” Staff Assignment Logic (THE ENGINE)

Add to repo.js:

repo.findAvailableStaff = async function (businessId, start, end, serviceId) {
  const [staff, bookings] = await Promise.all([
    repo.listStaffByBusiness(businessId),
    repo.listBookingsByBusiness(businessId)
  ]);

  const targetStart = new Date(start);
  const targetEnd = new Date(end);

  return staff.filter(member => {
    // Check if staff can perform service
    if (!member.services || !member.services.includes(serviceId)) {
      return false;
    }

    // Check weekly availability
    const day = targetStart.toLocaleString('en-GB', { weekday: 'short' });
    const avail = member.availability?.[day];
    if (!avail || !avail.start || !avail.end) return false;

    const startTime = timeToDate(targetStart, avail.start);
    const endTime = timeToDate(targetStart, avail.end);

    if (targetStart < startTime || targetEnd > endTime) return false;

    // Check booking conflicts
    const conflicts = bookings.some(b => {
      if (b.staffId !== member.id) return false;
      const bStart = new Date(b.start);
      const bEnd = new Date(b.end);
      return (
        (targetStart >= bStart && targetStart < bEnd) ||
        (targetEnd > bStart && targetEnd <= bEnd)
      );
    });

    return !conflicts;
  });
};

function timeToDate(date, time) {
  const [h, m] = time.split(':');
  const d = new Date(date);
  d.setHours(Number(h), Number(m), 0, 0);
  return d;
}

This function:
	â€¢	Looks at staff availability
	â€¢	Checks if staff can perform the service
	â€¢	Checks for overlapping bookings
	â€¢	Returns a list of available staff

Next patch: bookings will auto-assign staff.

â¸»

ğŸŸ¦ PART 6 â€” Add Routes

In App.jsx:

import { AdminStaffAvailability } from './AdminStaffAvailability';
import { AdminStaffServices } from './AdminStaffServices';

Add:

<Route path="/admin/staff/availability" element={<AdminGuard><AdminStaffAvailability /></AdminGuard>} />
<Route path="/admin/staff/services" element={<AdminGuard><AdminStaffServices /></AdminGuard>} />


â¸»

ğŸŸ¦ PART 7 â€” Add Sidebar Links

In Sidebar:

<SideLink to="/admin/staff/availability" label="Staff Availability" />
<SideLink to="/admin/staff/services" label="Staff Services" />


