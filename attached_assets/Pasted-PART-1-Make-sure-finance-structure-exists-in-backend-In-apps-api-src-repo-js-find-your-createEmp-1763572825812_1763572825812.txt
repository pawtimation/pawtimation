PART 1 â€” Make sure finance structure exists in backend

In apps/api/src/repo.js, find your createEmptyBusinessSettings() function and ensure its finance section looks like this (add or adjust if needed):

function createEmptyBusinessSettings() {
  return {
    // ...profile, hours, policies, branding...
    finance: {
      autoInvoicingEnabled: false,
      autoInvoicingFrequency: "disabled", // 'disabled' | 'per_job' | 'weekly' | 'fortnightly' | 'monthly'
      autoInvoicingTrigger: "completed",  // 'completed' | 'approved_past'
      sendMode: "draft",                  // 'draft' | 'auto'
      defaultPaymentTermsDays: 14,
      bankDetails: ""                     // free text block shown on invoices
    },
    services: [],
    permissions: {
      staffCanSeeClientContact: true,
      staffCanSeeInvoices: false,
      staffCanApproveJobs: false
    },
    automation: {
      sendInvoiceReminderOnDueDate: false,
      sendInvoiceReminderAfterDays: 0
    }
  };
}

If those keys are already there, great â€” no change needed, just confirm they match.

â¸»

ðŸ”§ PART 2 â€” Make sure settings API endpoints exist

In your API routes file (often apps/api/src/routes/businessRoutes.js or similar), you should have something like:

import { getBusinessSettings, updateBusinessSettings } from "../repo.js";

router.get("/business/:id/settings", async (req, res) => {
  const settings = await getBusinessSettings(req.params.id);
  res.json(settings);
});

router.put("/business/:id/settings", async (req, res) => {
  const updated = await updateBusinessSettings(
    req.params.id,
    req.body.settings || {}
  );
  res.json(updated);
});

If not, add this block to your business-related routes file.

â¸»

ðŸ”§ PART 3 â€” Frontend helper: businessApi

If you havenâ€™t already created it, add apps/web/src/lib/businessApi.js (or similar, match your structure):

import { auth } from "./auth";

export async function fetchBusinessSettings() {
  if (!auth.user?.businessId) {
    throw new Error("No businessId on current user");
  }

  const res = await fetch(`/api/business/${auth.user.businessId}/settings`, {
    headers: {
      Authorization: `Bearer ${auth.token}`
    }
  });

  if (!res.ok) {
    throw new Error("Failed to load business settings");
  }

  return res.json();
}

export async function saveBusinessSettings(settingsPatch) {
  if (!auth.user?.businessId) {
    throw new Error("No businessId on current user");
  }

  const res = await fetch(`/api/business/${auth.user.businessId}/settings`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${auth.token}`
    },
    body: JSON.stringify({ settings: settingsPatch })
  });

  if (!res.ok) {
    throw new Error("Failed to save business settings");
  }

  return res.json();
}

Weâ€™ll reuse this for all settings sections eventually.

â¸»

ðŸ”§ PART 4 â€” Wire up Finance Settings UI

Now we make the Finance section in Settings actually work.

Open your AdminSettings.jsx (the one we patched earlier with the mini-menu).
Find the FinanceSection function I gave you and replace it entirely with this version:

import React, { useEffect, useState } from "react";
// ... at the top of AdminSettings.jsx, add:
import { fetchBusinessSettings, saveBusinessSettings } from "../lib/businessApi";
// adjust the import path if your folder structure is different

// ...

function FinanceSection() {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState("");

  const [autoEnabled, setAutoEnabled] = useState(false);
  const [frequency, setFrequency] = useState("disabled");
  const [trigger, setTrigger] = useState("completed");
  const [sendMode, setSendMode] = useState("draft");
  const [defaultTerms, setDefaultTerms] = useState(14);
  const [bankDetails, setBankDetails] = useState("");

  useEffect(() => {
    let cancelled = false;
    async function load() {
      try {
        setLoading(true);
        const settings = await fetchBusinessSettings();
        if (cancelled) return;
        const finance = settings.finance || {};
        setAutoEnabled(Boolean(finance.autoInvoicingEnabled));
        setFrequency(finance.autoInvoicingFrequency || "disabled");
        setTrigger(finance.autoInvoicingTrigger || "completed");
        setSendMode(finance.sendMode || "draft");
        setDefaultTerms(
          typeof finance.defaultPaymentTermsDays === "number"
            ? finance.defaultPaymentTermsDays
            : 14
        );
        setBankDetails(finance.bankDetails || "");
        setError("");
      } catch (e) {
        console.error(e);
        if (!cancelled) {
          setError("Could not load finance settings.");
        }
      } finally {
        if (!cancelled) setLoading(false);
      }
    }
    load();
    return () => {
      cancelled = true;
    };
  }, []);

  async function handleSave() {
    setSaving(true);
    setError("");
    try {
      await saveBusinessSettings({
        finance: {
          autoInvoicingEnabled: autoEnabled,
          autoInvoicingFrequency: frequency,
          autoInvoicingTrigger: trigger,
          sendMode,
          defaultPaymentTermsDays: Number(defaultTerms) || 0,
          bankDetails
        }
      });
    } catch (e) {
      console.error(e);
      setError("Could not save finance settings.");
    } finally {
      setSaving(false);
    }
  }

  return (
    <div className="space-y-4">
      <header>
        <h2 className="text-sm font-semibold">Finance settings</h2>
        <p className="text-xs text-slate-600">
          Configure how invoices are generated, sent and paid.
        </p>
      </header>

      {loading ? (
        <p className="text-xs text-slate-600">Loading finance settingsâ€¦</p>
      ) : (
        <>
          {error && (
            <div className="text-xs text-red-600 border border-red-200 bg-red-50 px-3 py-2 rounded">
              {error}
            </div>
          )}

          <div className="space-y-3 text-sm">
            <Field label="Auto-invoicing">
              <select
                className="input"
                value={autoEnabled ? frequency : "disabled"}
                onChange={e => {
                  const value = e.target.value;
                  if (value === "disabled") {
                    setAutoEnabled(false);
                    setFrequency("disabled");
                  } else {
                    setAutoEnabled(true);
                    setFrequency(value);
                  }
                }}
              >
                <option value="disabled">Disabled</option>
                <option value="per_job">Per job</option>
                <option value="weekly">Weekly</option>
                <option value="fortnightly">Fortnightly</option>
                <option value="monthly">Monthly</option>
              </select>
            </Field>

            <Field label="When to invoice">
              <select
                className="input"
                value={trigger}
                onChange={e => setTrigger(e.target.value)}
                disabled={!autoEnabled}
              >
                <option value="completed">Completed jobs</option>
                <option value="approved_past">
                  Approved jobs with date in the past
                </option>
              </select>
            </Field>

            <Field label="Send mode">
              <select
                className="input"
                value={sendMode}
                onChange={e => setSendMode(e.target.value)}
                disabled={!autoEnabled}
              >
                <option value="draft">Create draft for review</option>
                <option value="auto">Generate and send automatically</option>
              </select>
            </Field>

            <Field label="Default payment terms (days)">
              <input
                className="input"
                type="number"
                min="0"
                value={defaultTerms}
                onChange={e => setDefaultTerms(e.target.value)}
              />
            </Field>

            <Field label="Bank details (shown on invoices)">
              <textarea
                className="input"
                rows={3}
                placeholder="Account name, sort code, account number"
                value={bankDetails}
                onChange={e => setBankDetails(e.target.value)}
              />
            </Field>
          </div>

          <div className="flex justify-end">
            <button
              className="btn btn-primary text-sm"
              type="button"
              onClick={handleSave}
              disabled={saving}
            >
              {saving ? "Savingâ€¦" : "Save finance settings"}
            </button>
          </div>
        </>
      )}
    </div>
  );
}

Note: This assumes Field and input/btn btn-primary classes already exist, as in the earlier version we built together.

