PATCH 6 ‚Äî Bulk Recurring Bookings (Admin)

Goal: from the admin side, quickly create lots of SCHEDULED jobs for a regular weekly pattern (Option A: fixed weekly schedule).

6.1. Create AdminBulkRecurring.jsx

Create a new file:
src/screens/AdminBulkRecurring.jsx

import React, { useEffect, useState } from 'react';
import { repo } from '../../repo.js';

const DAYS = [
  { label: 'Mon', value: 1 },
  { label: 'Tue', value: 2 },
  { label: 'Wed', value: 3 },
  { label: 'Thu', value: 4 },
  { label: 'Fri', value: 5 },
  { label: 'Sat', value: 6 },
  { label: 'Sun', value: 0 }
];

export function AdminBulkRecurring({ business }) {
  const [clients, setClients] = useState([]);
  const [dogs, setDogs] = useState([]);
  const [services, setServices] = useState([]);
  const [form, setForm] = useState({
    clientId: '',
    dogId: '',
    serviceId: '',
    startDate: '',
    time: '10:00',
    weeks: 4,
    daysOfWeek: [1, 3, 5] // default Mon/Wed/Fri
  });
  const [summary, setSummary] = useState('');
  const [error, setError] = useState('');
  const [createdCount, setCreatedCount] = useState(0);

  useEffect(() => {
    (async () => {
      if (!business) return;
      const [c, d, s] = await Promise.all([
        repo.listClientsByBusiness(business.id),
        repo.listDogsByBusiness(business.id),
        repo.listServicesByBusiness(business.id)
      ]);
      setClients(c);
      setDogs(d);
      setServices(s);
    })();
  }, [business]);

  function toggleDay(dayValue) {
    setForm(f => {
      const exists = f.daysOfWeek.includes(dayValue);
      return {
        ...f,
        daysOfWeek: exists
          ? f.daysOfWeek.filter(v => v !== dayValue)
          : [...f.daysOfWeek, dayValue]
      };
    });
  }

  function buildSchedulePreview() {
    if (!form.startDate || form.daysOfWeek.length === 0) return '';
    const start = new Date(form.startDate + 'T00:00:00');
    const items = [];
    for (let w = 0; w < Number(form.weeks || 0); w++) {
      for (const day of form.daysOfWeek) {
        const date = new Date(start);
        const offset =
          ((day - start.getDay() + 7) % 7) + w * 7;
        date.setDate(date.getDate() + offset);
        items.push(date.toDateString());
      }
    }
    return `${items.length} jobs over ${form.weeks} weeks`;
  }

  useEffect(() => {
    setSummary(buildSchedulePreview());
  }, [form.startDate, form.weeks, form.daysOfWeek]);

  async function handleSubmit(e) {
    e.preventDefault();
    setError('');
    setCreatedCount(0);

    if (!business) {
      setError('No business loaded.');
      return;
    }

    if (!form.clientId || !form.dogId || !form.serviceId || !form.startDate) {
      setError('Please choose client, dog, service and start date.');
      return;
    }

    if (form.daysOfWeek.length === 0) {
      setError('Choose at least one day of the week.');
      return;
    }

    const [hours, minutes] = form.time.split(':').map(Number);
    const startBase = new Date(form.startDate + 'T00:00:00');
    let created = 0;

    for (let w = 0; w < Number(form.weeks || 0); w++) {
      for (const day of form.daysOfWeek) {
        const date = new Date(startBase);
        const offset =
          ((day - startBase.getDay() + 7) % 7) + w * 7;
        date.setDate(date.getDate() + offset);
        date.setHours(hours, minutes, 0, 0);

        const startIso = date.toISOString();

        await repo.createJob({
          businessId: business.id,
          clientId: form.clientId,
          dogIds: [form.dogId],
          serviceId: form.serviceId,
          start: startIso,
          status: 'SCHEDULED',
          notes: 'Bulk recurring booking'
        });

        created++;
      }
    }

    setCreatedCount(created);
  }

  if (!business) {
    return <p className="text-sm text-slate-600">No business loaded.</p>;
  }

  const clientDogs = dogs.filter(d => d.clientId === form.clientId);

  return (
    <div className="space-y-4">
      <h1 className="text-xl font-semibold">Bulk recurring bookings</h1>
      <p className="text-xs text-slate-600">
        Create a regular weekly pattern (e.g. Mon/Wed/Fri at 10am) for a client and
        generate multiple scheduled jobs in one go.
      </p>

      <form onSubmit={handleSubmit} className="card space-y-3 max-w-xl">
        <div className="grid gap-3 md:grid-cols-2">
          <select
            className="border rounded px-3 py-2 text-sm"
            value={form.clientId}
            onChange={e =>
              setForm(f => ({ ...f, clientId: e.target.value, dogId: '' }))
            }
          >
            <option value="">Select client</option>
            {clients.map(c => (
              <option key={c.id} value={c.id}>
                {c.name || c.email}
              </option>
            ))}
          </select>

          <select
            className="border rounded px-3 py-2 text-sm"
            value={form.dogId}
            onChange={e =>
              setForm(f => ({ ...f, dogId: e.target.value }))
            }
          >
            <option value="">Select dog</option>
            {clientDogs.map(d => (
              <option key={d.id} value={d.id}>
                {d.name}
              </option>
            ))}
          </select>

          <select
            className="border rounded px-3 py-2 text-sm"
            value={form.serviceId}
            onChange={e =>
              setForm(f => ({ ...f, serviceId: e.target.value }))
            }
          >
            <option value="">Select service</option>
            {services.map(s => (
              <option key={s.id} value={s.id}>
                {s.name}
              </option>
            ))}
          </select>

          <input
            className="border rounded px-3 py-2 text-sm"
            type="date"
            value={form.startDate}
            onChange={e =>
              setForm(f => ({ ...f, startDate: e.target.value }))
            }
          />
        </div>

        <div className="grid gap-3 md:grid-cols-2">
          <div className="space-y-1">
            <label className="text-xs text-slate-600 block">
              Days of week
            </label>
            <div className="flex flex-wrap gap-2">
              {DAYS.map(d => (
                <button
                  key={d.value}
                  type="button"
                  onClick={() => toggleDay(d.value)}
                  className={
                    'px-2 py-1 text-xs rounded border ' +
                    (form.daysOfWeek.includes(d.value)
                      ? 'bg-emerald-500 text-white border-emerald-500'
                      : 'bg-white text-slate-700 border-slate-300')
                  }
                >
                  {d.label}
                </button>
              ))}
            </div>
          </div>

          <div className="space-y-1">
            <label className="text-xs text-slate-600 block">
              Time & weeks
            </label>
            <div className="flex gap-2">
              <input
                className="border rounded px-3 py-2 text-sm"
                type="time"
                value={form.time}
                onChange={e =>
                  setForm(f => ({ ...f, time: e.target.value }))
                }
              />
              <input
                className="border rounded px-3 py-2 text-sm w-20"
                type="number"
                min="1"
                max="52"
                value={form.weeks}
                onChange={e =>
                  setForm(f => ({ ...f, weeks: e.target.value }))
                }
              />
            </div>
            <div className="text-[11px] text-slate-500">
              {summary || 'Select a start date and days to see schedule summary.'}
            </div>
          </div>
        </div>

        {error && <p className="text-sm text-rose-600">{error}</p>}
        {createdCount > 0 && (
          <p className="text-sm text-emerald-700">
            Created {createdCount} jobs.
          </p>
        )}

        <button className="btn btn-primary text-sm" type="submit">
          Generate jobs
        </button>
      </form>
    </div>
  );
}

6.2. Wire it into App.jsx

In src/screens/App.jsx:
	1.	Add import near the top:

import { AdminBulkRecurring } from './AdminBulkRecurring';

	2.	Add route inside <Routes> (before the * catch-all):

<Route
  path="/admin/recurring"
  element={<AdminBulkRecurring business={business} />}
/>

	3.	(Optional) In QuickActions on the admin dashboard, add a link:

<Link className="btn btn-ghost w-full" to="/admin/recurring">
  Bulk recurring bookings
</Link>

(Just add that below your existing buttons.)

That‚Äôs Patch 6 ‚Äì the business can now bulk-generate recurring weekly jobs.

‚∏ª

üîß PATCH 7 ‚Äî Flexi Bookings (Client, F2)

Goal: Flexi clients can quickly book multiple walks for next week (or any week) in one go. Business still approves via the existing /admin/requests screen.

7.1. New screen: ClientFlexiBook.jsx

Create:
src/screens/ClientFlexiBook.jsx

import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { repo } from '../../repo.js';

const DAYS = [
  { label: 'Mon', value: 1 },
  { label: 'Tue', value: 2 },
  { label: 'Wed', value: 3 },
  { label: 'Thu', value: 4 },
  { label: 'Fri', value: 5 },
  { label: 'Sat', value: 6 },
  { label: 'Sun', value: 0 }
];

function getNextMonday() {
  const d = new Date();
  const day = d.getDay(); // 0-6, Sun-Sat
  const diff = (1 - day + 7) % 7 || 7; // days to next Monday
  d.setDate(d.getDate() + diff);
  return d.toISOString().slice(0, 10);
}

export function ClientFlexiBook() {
  const navigate = useNavigate();
  const [client, setClient] = useState(null);
  const [business, setBusiness] = useState(null);
  const [dogs, setDogs] = useState([]);
  const [services, setServices] = useState([]);
  const [form, setForm] = useState({
    weekStart: getNextMonday(),
    dogId: '',
    serviceId: '',
    time: '10:00',
    daysOfWeek: [1, 3, 5] // Mon/Wed/Fri
  });
  const [error, setError] = useState('');
  const [createdCount, setCreatedCount] = useState(0);

  useEffect(() => {
    (async () => {
      const raw = localStorage.getItem('pt_client');
      if (!raw) {
        navigate('/client/login');
        return;
      }
      const { clientId, businessId } = JSON.parse(raw);

      const [c, b, allDogs, allServices] = await Promise.all([
        repo.getClient(clientId),
        repo.getBusiness(businessId),
        repo.listDogsByBusiness(businessId),
        repo.listServicesByBusiness(businessId)
      ]);

      if (!c || !b) {
        localStorage.removeItem('pt_client');
        navigate('/client/login');
        return;
      }

      setClient(c);
      setBusiness(b);
      setDogs(allDogs.filter(d => d.clientId === c.id));
      setServices(allServices);
    })();
  }, [navigate]);

  function toggleDay(dayValue) {
    setForm(f => {
      const exists = f.daysOfWeek.includes(dayValue);
      return {
        ...f,
        daysOfWeek: exists
          ? f.daysOfWeek.filter(v => v !== dayValue)
          : [...f.daysOfWeek, dayValue]
      };
    });
  }

  async function handleSubmit(e) {
    e.preventDefault();
    setError('');
    setCreatedCount(0);

    if (!client || !business) return;

    if (!form.weekStart || !form.dogId || !form.serviceId) {
      setError('Choose week start, dog and service.');
      return;
    }

    if (form.daysOfWeek.length === 0) {
      setError('Select at least one day.');
      return;
    }

    const weekStart = new Date(form.weekStart + 'T00:00:00');
    const [hours, minutes] = form.time.split(':').map(Number);
    let created = 0;

    for (const day of form.daysOfWeek) {
      const date = new Date(weekStart);
      const offset = (day - weekStart.getDay() + 7) % 7;
      date.setDate(date.getDate() + offset);
      date.setHours(hours, minutes, 0, 0);

      const startIso = date.toISOString();

      await repo.createJob({
        businessId: business.id,
        clientId: client.id,
        dogIds: [form.dogId],
        serviceId: form.serviceId,
        start: startIso,
        status: 'REQUESTED',
        notes: 'Flexi weekly booking'
      });

      created++;
    }

    setCreatedCount(created);
    // After creating all requested jobs, go back to dashboard
    navigate('/client/dashboard');
  }

  if (!client || !business) {
    return (
      <div className="text-sm text-slate-600">
        Loading flexi booking‚Ä¶
      </div>
    );
  }

  return (
    <div className="max-w-xl mx-auto space-y-4">
      <h1 className="text-xl font-semibold">Flexi weekly booking</h1>
      <p className="text-xs text-slate-600">
        Quickly request multiple walks for a week. Your walker will approve and confirm
        exact times if needed.
      </p>

      <form onSubmit={handleSubmit} className="card space-y-3">
        <div className="grid gap-3 md:grid-cols-2">
          <div className="space-y-1">
            <label className="text-xs text-slate-600 block">
              Week starting
            </label>
            <input
              className="border rounded px-3 py-2 text-sm w-full"
              type="date"
              value={form.weekStart}
              onChange={e =>
                setForm(f => ({ ...f, weekStart: e.target.value }))
              }
            />
          </div>

          <div className="space-y-1">
            <label className="text-xs text-slate-600 block">
              Time of day
            </label>
            <input
              className="border rounded px-3 py-2 text-sm w-full"
              type="time"
              value={form.time}
              onChange={e =>
                setForm(f => ({ ...f, time: e.target.value }))
              }
            />
          </div>
        </div>

        <div className="grid gap-3 md:grid-cols-2">
          <select
            className="border rounded px-3 py-2 text-sm"
            value={form.dogId}
            onChange={e =>
              setForm(f => ({ ...f, dogId: e.target.value }))
            }
          >
            <option value="">Choose dog</option>
            {dogs.map(d => (
              <option key={d.id} value={d.id}>
                {d.name}
              </option>
            ))}
          </select>

          <select
            className="border rounded px-3 py-2 text-sm"
            value={form.serviceId}
            onChange={e =>
              setForm(f => ({ ...f, serviceId: e.target.value }))
            }
          >
            <option value="">Choose service</option>
            {services.map(s => (
              <option key={s.id} value={s.id}>
                {s.name}
              </option>
            ))}
          </select>
        </div>

        <div className="space-y-1">
          <label className="text-xs text-slate-600 block">
            Days this week
          </label>
          <div className="flex flex-wrap gap-2">
            {DAYS.map(d => (
              <button
                key={d.value}
                type="button"
                onClick={() => toggleDay(d.value)}
                className={
                  'px-2 py-1 text-xs rounded border ' +
                  (form.daysOfWeek.includes(d.value)
                    ? 'bg-emerald-500 text-white border-emerald-500'
                    : 'bg-white text-slate-700 border-slate-300')
                }
              >
                {d.label}
              </button>
            ))}
          </div>
        </div>

        {error && <p className="text-sm text-rose-600">{error}</p>}
        {createdCount > 0 && (
          <p className="text-sm text-emerald-700">
            Requested {createdCount} walks for that week.
          </p>
        )}

        <div className="flex gap-3">
          <button className="btn btn-primary text-sm" type="submit">
            Request week
          </button>
          <button
            type="button"
            className="btn btn-ghost text-sm"
            onClick={() => navigate('/client/dashboard')}
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  );
}

7.2. Wire flexi booking into App.jsx

In src/screens/App.jsx:
	1.	Add import near the others:

import { ClientFlexiBook } from './ClientFlexiBook';

	2.	Add route inside <Routes>:

<Route path="/client/flexi" element={<ClientFlexiBook />} />

(Again, before the * catch-all route.)

‚∏ª

7.3. Add link from Client Dashboard to Flexi Book

Open src/screens/ClientDashboard.jsx.

Find the part near the top of the return where we already have:

<div className="flex justify-end">
  <Link className="btn btn-primary btn-sm" to="/client/book">
    Request booking
  </Link>
</div>

Change it to:

<div className="flex justify-end gap-2">
  <Link className="btn btn-ghost btn-sm" to="/client/flexi">
    Flexi week booking
  </Link>
  <Link className="btn btn-primary btn-sm" to="/client/book">
    Request booking
  </Link>
</div>

Now clients see both:
	‚Ä¢	Single booking
	‚Ä¢	Flexi ‚Äúbook a whole week‚Äù

‚∏ª

‚úÖ What you have now

For the business (Patch 6):
	‚Ä¢	/admin/recurring
	‚Ä¢	Choose client, dog, service
	‚Ä¢	Choose start date, days of week, time, number of weeks
	‚Ä¢	Click Generate jobs
	‚Ä¢	System creates multiple SCHEDULED jobs in one go
	‚Ä¢	They appear on:
	‚Ä¢	/admin/jobs
	‚Ä¢	/admin/calendar
	‚Ä¢	/staff/calendar (for assigned staff later)

For flexi clients (Patch 7):
	‚Ä¢	/client/flexi
	‚Ä¢	‚ÄúWeek starting‚Äù (defaults to next Monday)
	‚Ä¢	Choose dog, service, time
	‚Ä¢	Select days of that week
	‚Ä¢	System creates multiple REQUESTED jobs
	‚Ä¢	Business sees them in /admin/requests, approves as usual
	‚Ä¢	Client sees statuses on /client/dashboard

This matches:
	‚Ä¢	A ‚Äì fixed weekly recurring pattern (admin-driven)
	‚Ä¢	F2 ‚Äì rolling weekly flexi clients with quick booking (client-driven, but still approved by business)