# Pawtimation CRM

## Overview
Pawtimation is a B2B SaaS platform designed for dog-walking and pet care businesses. Its primary purpose is to streamline operations by providing a comprehensive CRM for managing staff, clients, dogs, services, and job scheduling with intelligent staff assignment. The platform aims to enhance efficiency and organization for pet care service providers.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
### Monorepo Structure
The project is structured as a monorepo, separating the backend (`apps/api`) and frontend (`apps/web`).

### Backend Architecture
- **Framework**: Fastify (ES modules) for high performance, featuring schema validation and modular route files.
- **Data Storage**: Currently uses in-memory JavaScript objects with a repository pattern, designed for future migration to persistent storage like Postgres/Drizzle.
- **CRM Data Model**: A clean, multi-business CRM model is implemented with core entities including `businesses`, `users` (staff/admins), `clients`, `dogs`, `services`, `jobs`, `invoices`, `availability`, and `recurringJobs`. Legacy buckets are retained for compatibility but are largely unused in the current CRM model.
- **Authentication & Authorization**: Dual authentication system with separate helpers for client users (`getAuthenticatedClient`) and business/admin users (`getAuthenticatedBusinessUser`). Both verify JWT tokens and enforce role-based access control with proper business isolation to prevent cross-business data access.
- **Settings Persistence**: Business settings are stored in `businesses[id].settings` with comprehensive structure including profile (name, contact, address), working hours (per-day open/close times), policies (cancellation windows, payment terms), branding (color scheme, powered-by toggle), finance (auto-invoicing rules, bank details), and services (pricing, duration, visibility, staff assignment rules). Deep-merge logic (`mergeBusinessSettings`) ensures partial updates never lose existing data. Settings API routes include GET/PUT `/business/:id/settings` with authorization middleware ensuring only business owners, members, or admins can access settings.
- **Services Management**: Complete CRUD operations for business services stored in business settings. Service model includes name, price, duration, extra dog fees, weekend fees, client visibility, and staff assignment rules (any, seniorOnly, specific). API routes at `/business/:id/services` support GET, POST, PUT, and DELETE operations. Frontend service management UI integrated into Settings page with real-time updates.

### Frontend Architecture
- **Build Tool**: Vite.
- **Styling**: Tailwind CSS with a teal/emerald/cyan palette and custom CSS variables. Dedicated stylesheet modules for sidebar (`styles/sidebar.css`) and dashboard (`styles/dashboard.css`) components.
- **State Management**: React hooks.
- **Calendar System**: A custom weekly grid calendar component visualizes time slots and bookings, replacing FullCalendar.
- **Routing**: Clean React Router setup supporting distinct admin, staff, and client portals with role-aware navigation. Key routes include dashboards, staff management (availability, services), client management, service configuration, booking management, invoice viewing, bulk scheduling tools, and comprehensive admin settings.
- **UI/UX Decisions**: Features a persistent left sidebar with role-aware navigation for a cleaner interface, distinct admin and staff navigation menus with grouped Staff section (Team, Availability, Service Skills), and color-coded booking statuses for visual clarity (Requested: amber, Scheduled/Approved: teal/emerald, Complete: blue, Declined/Cancelled: rose). Dashboard features modern card grid with hover effects and chart placeholders. A 6-step client onboarding wizard ensures complete client profiles before booking access.
- **Technical Implementations**: Includes a comprehensive staff scheduling system with weekly availability management and service assignment, an intelligent staff ranking system for auto-assignment, real-time conflict detection, and a booking form modal for detailed job creation/editing. Bulk recurring booking and flexi-week booking tools are available for admins and clients, respectively.
- **Mobile Admin Interface**: Complete mobile-optimized admin interface for phones with viewport-based auto-redirect. Mobile detection utility (`apps/web/src/lib/isMobile.js`) checks if viewport < 768px. Admin users on mobile devices are automatically redirected from desktop routes (`/`, `/admin`, `/admin/*`) to mobile interface (`/admin/m/dashboard`) using replace-style navigation to prevent history pollution. Desktop sidebar hidden on mobile using `hidden md:flex` Tailwind classes. Mobile layout (`apps/web/src/layouts/AdminMobileLayout.jsx`) provides fixed bottom navigation with 5 tabs: Home, Clients, Calendar, Jobs, and Menu. DashboardLayout includes early return for mobile routes to prevent interference. Five placeholder screens created in `apps/web/src/screens/admin/mobile/` ready for future implementation (Patches A2-A6).

### System Design Choices
- **Staff Assignment Intelligence**: Utilizes a sophisticated logic (`apps/web/src/lib/staff.js`) to rank staff based on qualifications, availability, and conflict status, providing a match score. This system also handles conflict detection and availability checking.
- **Repository Pattern**: All data operations are abstracted through `repo.js`, providing a consistent interface for managing businesses, users, clients, dogs, services, jobs, availability, invoices, and job updates. Job statuses are carefully managed, with only `SCHEDULED`, `APPROVED`, `COMPLETE`, and `COMPLETED` jobs blocking staff availability, and `COMPLETE`/`COMPLETED` jobs triggering automatic invoice generation.
- **Client Portal**: Features a client-facing portal with comprehensive booking workflows, including:
  - **Booking Management**: Full CRUD operations on client bookings through secure API endpoints (`apps/api/src/routes/jobRoutes.js`) with JWT authentication and ownership verification. Endpoints include creating job requests (POST `/api/jobs/create`), listing jobs, viewing individual bookings, editing pending requests, and canceling bookings.
  - **Create Booking Flow**: Enhanced booking form (`/client/book`) with multi-dog checkbox selection, service dropdown displaying duration and pricing, comprehensive validation with clear error messages, loading states, and helpful empty states linking to dog management when no dogs exist.
  - **Edit Booking Flow**: Clients can edit pending booking requests (`/client/book/edit`) to change date/time, selected dogs, and notes. Only jobs in `REQUESTED` or `pending` status can be modified.
  - **Repeat Booking**: Completed bookings include a "Book again" action that pre-fills the booking form with the previous job's service, selected dogs, notes, and start time. Smart datetime handling preserves wall-clock times across both naive datetime-local formats and timezone-aware ISO strings using timezone detection (`/Z|[+-]\d{2}:\d{2}$/`).
  - **Booking Display**: Enhanced booking list with status-based styling (amber for pending, green for approved, blue for completed, grey for cancelled), safe date handling for invalid timestamps, and action buttons contextual to booking status.
  - **Security**: All booking operations verify JWT authentication and enforce that clients can only access/modify their own bookings. The `getAuthenticatedClient()` helper validates JWT, extracts user identity, and confirms the user is a client with a CRM record before allowing any operations. Dog ownership validation prevents clients from booking with other clients' dogs. Service validation ensures services exist and belong to the correct business.
  - **API Layer**: Frontend uses dedicated API wrappers (`apps/web/src/lib/jobApi.js`, `apps/web/src/lib/clientsApi.js`, `apps/web/src/lib/servicesApi.js`) that handle authentication headers and error responses, maintaining separation between UI and data access. Service API includes `listBusinessServices()` for fetching available services.
  - **Onboarding**: 6-step wizard ensures complete client profiles before booking access. Client Guard restricts access to booking features until profile completion.
  - **Client Notifications**: Automatic notification system that detects booking status changes and alerts clients. When admins approve or decline booking requests, clients see notifications on their next bookings page visit. Features include: localStorage-based notification store (`apps/web/src/lib/clientNotifications.js`), real-time badge display in navigation showing unread count, notifications feed page (`/client/notifications`) with mark-all-read functionality, status change detection comparing previous booking statuses with current (detects REQUESTED→APPROVED/SCHEDULED and REQUESTED→CANCELLED/DECLINED transitions), and event-driven badge updates using custom 'notificationsRead' event for immediate UI feedback when viewing notifications.
- **Admin Workflow**: Includes a comprehensive admin approval workflow for client booking requests through a dedicated Pending Requests screen (`/admin/requests`), comprehensive booking management, and invoice generation with payment links and WhatsApp sharing. The Pending Requests feature provides a clean interface for reviewing, approving, or declining client booking requests with full authentication and business isolation.
- **Admin Settings System**: Comprehensive 8-section settings page with left mini-menu navigation (Business profile, Working hours, Policies, Branding, Finance settings, Service pricing, Staff permissions, Automation rules). Finance settings section features full backend persistence with auto-invoicing configuration (frequency, trigger conditions, send mode), default payment terms, and bank details. Service pricing section provides complete service management with inline editing of prices, durations, fees, visibility, and staff assignment rules. Staff permissions section enables role-based access control with a permission matrix for admin and staff roles, controlling access to finances, settings, client information, invoices, and job approvals. Automation rules section provides 6 automation types with configurable triggers and settings. Settings persist to backend via dedicated API helpers (`businessApi` for settings, `servicesApi` for service CRUD operations, `automationApi` for automation configuration).
- **Role-Based Permissions System**: Granular permission control with role definitions stored in business settings. System supports admin and staff roles with customizable permissions including canSeeFinance, canEditBusinessSettings, canViewClients, canViewClientAddresses, canViewInvoices, canApproveJobs, and canAssignJobs. Permission middleware (`apps/api/src/middleware/permissions.js`) protects sensitive routes, and frontend helper (`apps/web/src/lib/permissions.js`) provides hasPermission() function for conditional UI rendering based on user roles.
- **Automation System**: Backend automation engine (`apps/api/src/automationEngine.js`) with 6 automation types: booking reminder emails (configurable hours before), invoice overdue reminders (days past due), daily summary emails (scheduled time), auto-mark jobs completed (hours after end time), staff conflict alerts (enabled by default), and weekly revenue snapshots (configurable day). Automation settings stored in business settings with dedicated API routes (`apps/api/src/routes/automationRoutes.js`) for GET/PUT operations. Frontend UI provides toggle controls with conditional configuration fields for each automation type.
- **Messaging System**: Complete business-level messaging infrastructure for client-business communication with full UI implementation supporting both booking-specific conversations and general inbox messaging. Messages stored in `businesses[id].messages` array. Backend repository functions (`addBusinessMessage`, `listMessagesForBooking`, `listMessagesForInbox`, `markBookingRead`, `markInboxRead`) handle CRUD operations with proper multi-tenant isolation. API endpoints at `/api/messages/send` (POST), `/api/messages/booking` (GET), `/api/messages/inbox` (GET), `/api/messages/booking/:bookingId/read` (POST), and `/api/messages/inbox/read` (POST) provide HTTP access. Frontend includes API wrapper (`apps/web/src/lib/messagesApi.js`) and four messaging UI screens: **Booking Messages** - `ClientBookingMessages` for client-side booking messaging (`/client/booking/messages?id=xxx`) with "View messages" links on all booking cards showing unread count badges, and `BookingMessages` for admin-side booking messaging (`/admin/booking/messages?id=xxx`) with automatic clientId fetching from booking details; **General Inbox** - `ClientInbox` for general client messaging (`/client/messages`) accessible via sidebar navigation with unread badge, and `BusinessInbox` for admin messaging (`/admin/messages`) with client selector dropdown. Message model includes id, bookingId (nullable - null for general inbox, set for booking messages), clientId, businessId, senderRole (client/business), message text, createdAt timestamp, and readStates object with {client: boolean, business: boolean} tracking read status for both parties independently. **Read/Unread Tracking**: Comprehensive system automatically marks messages as read when viewed, with immediate badge refresh via custom 'messagesRead' event. ClientLayout displays unread inbox count in navigation, and booking cards show per-booking unread message counts. All mark-read operations centralized in `load()` functions to ensure badges update after initial viewing and when new messages arrive.
- **Demo Client Seeder**: Automatically creates a demo client account (`demo@client.com / test123`) on startup for easy testing.

## External Dependencies
- **Backend Libraries**: `fastify`, `@fastify/cors`, `dotenv`, `stripe` (stubbed), `nanoid`, `node-fetch`, `raw-body`, `socket.io`.
- **Frontend Libraries**: `react`, `react-dom`, `react-router-dom`, `vite`, `@vitejs/plugin-react`, `tailwindcss`, `autoprefixer`, `postcss`, `socket.io-client`.
- **Third-Party Services**: Stripe (for payment processing, currently in stub mode).
- **Environment Variables**: `API_PORT`, `VITE_API_BASE`, `STRIPE_SECRET_KEY` (optional).