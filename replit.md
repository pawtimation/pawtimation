# Pawtimation CRM

## Overview
Pawtimation is a B2B SaaS platform designed to streamline operations for dog-walking and pet care businesses. It offers a comprehensive CRM solution for managing staff, clients, pets, services, and job scheduling, including intelligent staff assignment. The platform aims to enhance efficiency and support business growth through features like a dedicated staff UI, drag-and-drop calendar rescheduling, dynamic walking route generation, real-time dashboards, and extensive branding customization, culminating in a production-ready MVP with integrated payment processing.

## Recent Changes (November 23, 2025)
- **Production Critical Fixes**: Fixed System Health page crash caused by NaN rendering error in billing health calculation - applied per-operand fallbacks (line 169 OwnerHealthContent.jsx) ensuring undefined values default to 0 before addition. Fixed mobile UI responsive styling regression on Admin Dashboard - restored consistent icon sizing (w-5 h-5 on mobile), progressive text scaling (text-2xl sm:text-3xl md:text-5xl), and optimized spacing (mb-1 md:mb-2) across all 8 stat cards for proper mobile display
- **Blueprint-Aligned Revenue Recognition**: Fixed getRevenueByStaff to use BILLED invoice_items instead of COMPLETED jobs, ensuring only revenue from paid invoices is counted. Implemented invoice_item voiding when COMPLETED jobs are cancelled (only PENDING items void, BILLED items remain). Created data integrity repair functions (repairOrphanedInvoiceItems, findUnbilledInvoiceItems) for COMPLETED jobs missing invoice_items, creating them with PENDING status for admin batching. Added Super Admin endpoints (/owner/health/repair-orphaned-items, /owner/health/unbilled-items/:businessId) for data integrity management and repair
- **System Health Page Fix**: Fixed critical bug where System Health tab in Super Admin dashboard showed "Oops something went wrong" error. Issue was caused by repo.js calling non-existent `storage.getAvailabilityByBusiness()` function in getActiveStaffStats() and getPendingActions(). Fixed by properly iterating through staff and calling existing `storage.getAvailabilityByStaff(staffId)` for each staff member. System Health page now loads correctly
- **Super Admin Credentials Updated**: Changed super admin login from owner@pawtimation.com to andy@pawtimation with secure password. Credentials securely stored with bcrypt hashing in database
- **Admin Dashboard Complete Redesign**: Transformed main admin Dashboard into comprehensive business command center with personalized time-based greeting, 8 KPI cards in 2-row layout (Workload Overview: Today's Jobs hero card with teal gradient, This Week's Jobs with change indicator, Active Clients, Active Staff; Finance Snapshot: Revenue Last 7 Days clickable to Finance, Unpaid Invoices amber gradient, Overdue Invoices conditional red/green, Paid This Month), period-toggle charts (Jobs over time: 7d/30d/90d), enhanced Service breakdown and Revenue trend charts with subtitles, Action Centre showing pending items (overdue invoices, pending bookings, incomplete client details, staff without availability) with deep links or "All caught up" state, and Recent Activity feed displaying last 5 business activities with color-coded icons and relative timestamps. Created 8 new backend endpoints (/stats/bookings/today-count, /stats/bookings/week-count, /stats/staff/active-count, /stats/clients/new-this-month, /stats/invoices/revenue-7days, /stats/invoices/paid-this-month, /stats/activity/recent, /stats/actions/pending) with repository methods for all data aggregation. Renamed "Invoicing" to "Finance" throughout app (sidebar navigation, page headers). Finance page header updated to match Dashboard style with title and subtitle
- **Super Admin System Health Dashboard**: Added comprehensive monitoring dashboard to Owner Portal with 5 new backend endpoints (/owner/health/status, /alerts, /metrics, /activity, /integrity) and full frontend component. Monitors system uptime, error rates, business activity (walks, users, messaging, invoices), data integrity checks (orphaned records, conflicts), and billing health (Stripe failures). Features auto-refresh (60s), lazy-loaded charts, live alerts panel, and color-coded status indicators. Note: API telemetry instrumentation (response times, error breakdowns) is a future enhancement - currently displays business metrics and data validation checks with real production data
- **Super Admin Portal Tab-Based Navigation**: Transformed OwnerDashboard from page-based to tab-based navigation with 6 tabs (Platform Overview, All Businesses, Sales & Billing, System Health, User Feedback, System Logs) loading content in-place without navigation. Created tab content components (OwnerHealthContent, OwnerFeedbackContent, OwnerLogsContent, OwnerSalesContent) using shared ownerApi helper from lib/auth for consistent authentication. Fixed endpoint routing to use /owner/* routes instead of /api/*, eliminated trailing query parameter issues, and preserved pagination state. Removed standalone routes from App.jsx for cleaner architecture
- **Staff Calendar UX Overhaul**: Complete redesign of StaffSimpleCalendar empty states with warm, helpful messaging ("No walks today - Enjoy the day! Check your upcoming schedule below."), Next Upcoming Job card showing time/dog/service/client/location with smart date formatting ("Tomorrow at 10:30 AM"), Coming Up mini-list (3 upcoming days with walk counts, clickable to jump to date), Quick Actions row (Messages/Home/Availability), subtle gradient backgrounds, and enhanced Today button - transforms calendar from blank sheet into comprehensive scheduling tool
- **Staff Home Page Redesign**: Transformed StaffToday into warm, professional mobile experience with personalized time-based greeting ("Good morning, Sarah!"), "Next Up" preview showing tomorrow's first walk when today is empty, Quick Actions row (Messages, Calendar, Availability), weekly stats tiles (walks completed + earnings with friendly empty states), subtle teal gradient background, and brand personality touches (paw emoji, encouraging messages)
- **Client Home Page Enhancement**: Added personalized welcome header with greeting and overlapping dog avatars, "Upcoming Appointments" section showing next 3 bookings, "Recent Activity" feed of last 3 completed walks, primary dog profile card with breed/age/colour, soft teal-to-white gradient background, and comprehensive data loading via parallel API calls
- **Client Dogs Page Polish**: Implemented circular gradient dog avatars with paw icons, subtle background gradient, "+ Add New Dog" interactive card (not button), dog count display, and helpful tips section
- **Client Dog Management**: Implemented comprehensive dog management for clients with modal-based add/edit interface matching admin style, displaying all dog details (behaviour, medical, feeding, walking notes), secured via clientApi endpoints
- **Client Settings Always Editable**: Removed edit toggle, all fields now always editable with "Save Changes" button for simpler self-service UX
- **Staff Quick Login Fix**: Corrected owner portal quick login redirect from `/staff/today` to `/staff` (correct route)
- **Admin Dashboard Preview**: Updated homepage banner to show realistic admin dashboard with 8 stat cards matching actual dashboard layout
- **Footer Visibility**: Admin pages now display footer with legal/support links; client and staff mobile pages have no footer for clean UI
- **Staff Availability Time Pickers**: Updated StaffSettings availability section to use TimePicker component (matching admin working hours style) for consistent, searchable time selection across the platform
- **ClientGuard Security Enhancement**: Implemented secure authentication guard with in-memory validation caching (3-min freshness), exponential backoff retry logic (5 attempts over ~6s) to handle cookie propagation races, authoritative server validation, and automatic session cleanup on failure
- **Booking Edit Fix**: Added dogs array reset in BookingFormModal before loading client dogs, preventing null reference errors that caused ErrorBoundary "Oops" screen when editing bookings

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
Pawtimation utilizes a monorepo structure, separating the backend (`apps/api`) and frontend (`apps/web`).

### UI/UX Decisions
The frontend employs consistent design elements including a persistent left sidebar, modern card-grid dashboards, standardized color-coded booking statuses, a 6-step client onboarding wizard, and dynamic business branding. It features dedicated interfaces for admins, staff, and clients with role-specific dashboards, calendars, and settings, optimized for mobile with touch-friendly components. Reusable components for interactive and read-only maps utilize MapTiler tiles and mobile-optimized controls. Staff Messages rebuilt to match Admin Messages format using inbox API instead of booking messages, with client-based messaging, search functionality, and consistent teal theme. Client portal simplified with Message button removed from home dashboard. Client Settings page enhanced with editable name, emergency contact details, and veterinary information. Staff Availability features premium UI with gradient backgrounds, enhanced typography, and mobile-responsive design.

### Technical Implementations
The backend is built with Fastify (ES modules) using schema validation and PostgreSQL with Drizzle ORM and a repository pattern. Real-time updates are handled by Socket.io. Authentication is JWT-based with role-specific guards and multi-session isolation. Media and file storage are integrated with Replit Object Storage, featuring business isolation and role-based access control. The frontend uses Vite, React, and Tailwind CSS, with Recharts for data visualization and React Router for navigation. Performance optimizations include production indexes, N+1 query elimination, database query batching, and lazy loading for charts and maps. Automated database backups to Replit Object Storage are implemented.

### Feature Specifications
The platform supports a comprehensive CRM data model for businesses, users, clients, pets, services, jobs, and invoices. Key features include intelligent staff assignment based on qualifications and availability, client address management with GPS geocoding, and a robust booking workflow supporting both client-initiated requests and admin-created bookings. Invoice management includes multi-item invoicing, professional PDF generation, automated overdue calculations, and email reminders. Financial analytics provide reporting for revenue and trends. Walking route generation combines geometric algorithms with OpenRouteService integration. The system also includes a beta/trial management system, plan status tracking with automated access control, and a pricing tier framework. An events system, enhanced feedback system, and a Super Admin Owner Portal are also part of the platform. GDPR compliance is operational with data export and right to erasure capabilities. Security hardening includes comprehensive log sanitization, production-grade file upload security (MIME detection, magic number verification, server-generated filenames), signed file URLs, command injection prevention, strict CORS, rate limiting, and business isolation. Field-level encryption for sensitive financial data is planned.

### System Design Choices
Core architectural patterns include a monorepo structure, a repository pattern for data operations, and a robust role-based permission system enforced via middleware. Session management uses multi-role isolated localStorage keys and role-aware API helpers (clientApi, staffApi, adminApi) with /me endpoints for identity resolution, preventing cross-portal data leakage and eliminating legacy localStorage auth dependencies. Security is a primary concern, with features like rate-limited authentication endpoints, comprehensive log sanitization, and strict file upload validation.

## External Dependencies
-   **Backend Libraries**: `fastify`, `@fastify/cors`, `@fastify/jwt`, `@fastify/static`, `@fastify/cookie`, `@fastify/rate-limit`, `@replit/object-storage`, `dotenv`, `stripe`, `nanoid`, `node-fetch`, `raw-body`, `socket.io`, `bcryptjs`, `pdfkit`, `dayjs`.
-   **Frontend Libraries**: `react`, `react-dom`, `react-router-dom`, `vite`, `@vitejs/plugin-react`, `tailwindcss`, `autoprefixer`, `postcss`, `socket.io-client`, `recharts`, `@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities`, `dayjs`, `leaflet`, `react-leaflet`.
-   **Third-Party Services**: Stripe (payment processing, Stripe Connect), Nominatim API (geocoding), MapTiler (map tiles), OpenRouteService (walking route calculation).