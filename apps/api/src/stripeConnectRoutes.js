import { stripe } from './stripeClient.js';import { repo } from './repo.js';
export default async function stripeConnectRoutes(app){if(!stripe)app.log.warn('Stripe not configured; using stub.');
app.post('/stripe/connect/account',async(req,reply)=>{const {sitterId,email}=req.body||{};if(!sitterId||!email)return reply.code(400).send({error:'Missing'});if(!stripe)return{accountId:'acct_stub_'+sitterId,onboardingUrl:'https://example.com'};const acct=await stripe.accounts.create({type:'express',email});const link=await stripe.accountLinks.create({account:acct.id,refresh_url:process.env.PUBLIC_WEB_URL+'/onboarding/refresh',return_url:process.env.PUBLIC_WEB_URL+'/onboarding/return',type:'account_onboarding'});await repo.upsertSitter({id:sitterId,stripeAccountId:acct.id});return{accountId:acct.id,onboardingUrl:link.url}})
app.post('/stripe/checkout',async(req,reply)=>{const {bookingId,amountCents,sitterStripeAccountId,applicationFeeBps=1500,currency='gbp'}=req.body||{};if(!bookingId||!amountCents||!sitterStripeAccountId)return reply.code(400).send({error:'Missing'});if(!stripe)return{clientSecret:'cs_stub_'+bookingId,paymentIntentId:'pi_stub_'+bookingId};const fee=Math.floor(amountCents*(applicationFeeBps/10000));const pi=await stripe.paymentIntents.create({amount:amountCents,currency,automatic_payment_methods:{enabled:true},transfer_data:{destination:sitterStripeAccountId},application_fee_amount:fee,metadata:{bookingId}});return{clientSecret:pi.client_secret,paymentIntentId:pi.id}})
}
