import { repo } from './repo.js';
function computeForfeit(b){const daysOut=(new Date(b.startDate).getTime()-Date.now())/(1000*60*60*24);const total=b.total||(b.ratePerDay||0);if(daysOut>=7)return 0;if(daysOut>=3)return Math.floor(total*0.5);const firstDay=b.ratePerDay||Math.floor(total);return Math.max(firstDay,Math.floor(total*0.5))}
export default async function cancellationRoutes(app){app.get('/bookings/:id/cancel/quote',async(req,reply)=>{const {id}=req.params;const b=await repo.getBooking(id);if(!b)return reply.code(404).send({error:'Not found'});const fee=computeForfeit(b);return{bookingId:id,forfeitCents:fee,currency:'gbp',policyVersion:'1.0-2025-10-04'}});app.post('/bookings/:id/cancel',async(req,reply)=>{const {id}=req.params;const {actor='OWNER'}=req.body||{};const b=await repo.getBooking(id);if(!b)return reply.code(404).send({error:'Not found'});const fee=computeForfeit(b);await repo.recordCancellation({bookingId:id,actor,policyVersion:'1.0-2025-10-04',feeCents:fee,status:fee>0?'FORFEITED':'WAIVED'});await repo.setBookingStatus(id,'CANCELLED');return{ok:true,bookingId:id,forfeitCents:fee}})}
